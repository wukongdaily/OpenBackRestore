#!/bin/sh

red() { echo -e "\033[31m\033[01m[WARNING] $1\033[0m"; }
green() { echo -e "\033[32m\033[01m[INFO] $1\033[0m"; }
yellow() { echo -e "\033[33m\033[01m[NOTICE] $1\033[0m"; }
blue() { echo -e "\033[34m\033[01m[MESSAGE] $1\033[0m"; }
light_magenta() { echo -e "\033[95m\033[01m[NOTICE] $1\033[0m"; }
light_yellow() { echo -e "\033[93m\033[01m[NOTICE] $1\033[0m"; }

backup() {
    # è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆæ ¼å¼ï¼šå¹´æœˆæ—¥_æ—¶åˆ†ç§’ï¼‰
    local timestamp=$(date +%Y%m%d_%H%M%S)
    
    # è®¾ç½®ä¿ç•™æ—§å¤‡ä»½å¤©æ•°ï¼ˆé»˜è®¤7å¤©ï¼‰
    local keep_days=7
    
    # æ£€æŸ¥æ˜¯å¦ä¼ å…¥è‡ªå®šä¹‰è·¯å¾„
    local backup_path=${1:-/tmp/upload}
    mkdir -p "$backup_path"
    cd "$backup_path" || exit
    
    # å¤‡ä»½è½¯ä»¶æºé…ç½®
    cp /etc/opkg/distfeeds.conf distfeeds.conf
    
    # å¤‡ä»½å·²å®‰è£…è½¯ä»¶åˆ—è¡¨
    opkg list-installed > packages-list.txt
    
    # å¤‡ä»½ overlayï¼ˆç³»ç»Ÿé…ç½®å’Œæ›´æ”¹ï¼‰
    tar -czvf overlay_backup.tar.gz /overlay
    
    # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æœ€ç»ˆå¤‡ä»½æ–‡ä»¶
    local final_filename="backup_${timestamp}.tar.gz"
    tar -czvf "$final_filename" distfeeds.conf packages-list.txt overlay_backup.tar.gz
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -rf distfeeds.conf packages-list.txt overlay_backup.tar.gz
    
    # è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ï¼ˆæŒ‰ä¿®æ”¹æ—¶é—´ï¼‰
    yellow "æ­£åœ¨æ¸…ç†${keep_days}å¤©å‰çš„æ—§å¤‡ä»½..."
    find "$backup_path" -name "backup_*.tar.gz" -mtime +$keep_days -exec rm -fv {} \;
    
    green "âœ… ç³»ç»Ÿå¤‡ä»½æ–‡ä»¶å·²ä¿å­˜è‡³ï¼š$backup_path/$final_filename"
    light_magenta "ğŸ’¾ è¯·åŠæ—¶ä¸‹è½½ä¿å­˜åˆ°ç”µè„‘ä¾›æ¢å¤æ—¶ä½¿ç”¨"
}

backup "$1"